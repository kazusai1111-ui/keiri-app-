<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="çµŒè²»ãƒ¡ãƒ¢">
<meta name="theme-color" content="#1a1a2e">
<title>çµŒè²»ãƒ¡ãƒ¢</title>
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a2e'/><text y='65' x='50' text-anchor='middle' font-size='55'>ğŸ’¼</text></svg>">

<style>
  :root {
    --bg: #0f0f1a;
    --surface: #1a1a2e;
    --surface2: #252540;
    --accent: #f5c842;
    --accent2: #ff6b6b;
    --text: #f0f0f0;
    --text2: #999;
    --green: #4ade80;
    --blue: #60a5fa;
    --purple: #a78bfa;
    --safe-top: env(safe-area-inset-top, 44px);
    --safe-bottom: env(safe-area-inset-bottom, 34px);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* SPLASH SCREEN */
  #splash {
    position: fixed; inset: 0; z-index: 999;
    background: var(--bg);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 16px;
    transition: opacity 0.5s ease;
  }
  #splash .icon { font-size: 72px; animation: pulse 1s ease-in-out; }
  #splash .title { font-size: 28px; font-weight: 700; color: var(--accent); letter-spacing: 0.05em; }
  #splash .sub { font-size: 14px; color: var(--text2); }
  @keyframes pulse { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

  /* INSTALL BANNER */
  #install-banner {
    display: none;
    background: var(--accent);
    color: #000;
    padding: 12px 16px;
    padding-top: calc(12px + var(--safe-top));
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    gap: 8px;
    flex-direction: column;
  }
  #install-banner .banner-close {
    position: absolute; right: 12px; top: calc(10px + var(--safe-top));
    font-size: 20px; background: none; border: none; color: #000; cursor: pointer;
  }

  /* HEADER */
  header {
    background: var(--surface);
    padding: 12px 16px;
    padding-top: calc(12px + var(--safe-top));
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid rgba(255,255,255,0.07);
    flex-shrink: 0;
  }
  .header-title { font-size: 20px; font-weight: 700; }
  .header-title span { color: var(--accent); }
  .year-btn {
    background: var(--surface2); border: 1px solid rgba(255,255,255,0.1);
    color: var(--text); padding: 6px 14px; border-radius: 20px;
    font-size: 13px; font-weight: 600; cursor: pointer;
  }

  /* TABS */
  .tabs {
    display: flex; background: var(--surface); border-bottom: 1px solid rgba(255,255,255,0.07);
    flex-shrink: 0;
  }
  .tab {
    flex: 1; padding: 12px 4px; text-align: center; cursor: pointer;
    font-size: 11px; color: var(--text2); border-bottom: 2px solid transparent;
    transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 2px;
  }
  .tab .tab-icon { font-size: 20px; }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* MAIN CONTENT */
  main { flex: 1; overflow: hidden; position: relative; }
  .page { position: absolute; inset: 0; overflow-y: auto; display: none; padding-bottom: 20px; }
  .page.active { display: block; }

  /* SCAN PAGE */
  .scan-area {
    margin: 20px 16px 0;
    border: 2px dashed rgba(245, 200, 66, 0.4);
    border-radius: 16px;
    padding: 32px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: rgba(245, 200, 66, 0.03);
  }
  .scan-area:active { background: rgba(245, 200, 66, 0.08); transform: scale(0.98); }
  .scan-area .scan-icon { font-size: 48px; margin-bottom: 12px; }
  .scan-area p { color: var(--text2); font-size: 14px; line-height: 1.6; }
  .scan-area p strong { color: var(--text); }
  #file-input { display: none; }

  /* PREVIEW */
  #preview-section { display: none; margin: 16px; }
  #preview-img { width: 100%; border-radius: 12px; max-height: 200px; object-fit: contain; background: var(--surface2); }

  /* READING STATUS */
  #reading-status {
    display: none; margin: 16px;
    background: var(--surface);
    border-radius: 12px; padding: 16px;
    text-align: center;
  }
  .spinner {
    width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.1);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* RESULT CARD */
  #result-card {
    display: none; margin: 16px;
    background: var(--surface); border-radius: 16px; padding: 20px;
  }
  .result-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .result-label { font-size: 12px; color: var(--text2); }
  .result-value { font-size: 15px; font-weight: 600; }
  .amount-big { font-size: 28px; font-weight: 800; color: var(--accent); }

  /* CATEGORY SELECTOR */
  .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0 16px; }
  .cat-btn {
    padding: 12px 8px; border-radius: 12px; text-align: center;
    border: 2px solid rgba(255,255,255,0.08); background: var(--surface2);
    cursor: pointer; transition: all 0.15s; font-size: 12px; color: var(--text2);
  }
  .cat-btn .cat-icon { font-size: 22px; display: block; margin-bottom: 4px; }
  .cat-btn.selected { border-color: var(--accent); background: rgba(245,200,66,0.1); color: var(--accent); }
  .cat-btn.auto-detected { border-color: var(--green); background: rgba(74,222,128,0.08); color: var(--green); }

  .save-btn {
    width: 100%; padding: 16px; border-radius: 14px;
    background: var(--accent); color: #000; font-size: 16px; font-weight: 700;
    border: none; cursor: pointer; transition: all 0.15s;
  }
  .save-btn:active { transform: scale(0.97); }
  .save-btn:disabled { opacity: 0.4; }

  /* LIST PAGE */
  .list-filters {
    padding: 12px 16px; display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none;
  }
  .list-filters::-webkit-scrollbar { display: none; }
  .filter-chip {
    padding: 6px 14px; border-radius: 20px; white-space: nowrap;
    font-size: 12px; font-weight: 600; cursor: pointer;
    background: var(--surface2); color: var(--text2);
    border: 1px solid rgba(255,255,255,0.08); transition: all 0.15s;
  }
  .filter-chip.active { background: var(--accent); color: #000; border-color: var(--accent); }

  .expense-item {
    margin: 6px 16px; background: var(--surface); border-radius: 14px;
    padding: 14px 16px; display: flex; align-items: center; gap: 12px;
    animation: slideIn 0.2s ease;
  }
  @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .expense-cat-icon { font-size: 28px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: var(--surface2); border-radius: 10px; flex-shrink: 0; }
  .expense-info { flex: 1; min-width: 0; }
  .expense-cat-name { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
  .expense-date { font-size: 11px; color: var(--text2); }
  .expense-memo { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .expense-amount { font-size: 16px; font-weight: 800; color: var(--accent); flex-shrink: 0; }
  .delete-btn { background: none; border: none; color: var(--accent2); font-size: 18px; cursor: pointer; padding: 4px; flex-shrink: 0; }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--text2); }
  .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }

  /* SUMMARY PAGE */
  .summary-header { padding: 20px 16px 8px; }
  .total-card {
    background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%);
    border-radius: 20px; padding: 24px; margin: 0 16px 16px;
    border: 1px solid rgba(245,200,66,0.2);
  }
  .total-label { font-size: 13px; color: var(--text2); margin-bottom: 4px; }
  .total-amount { font-size: 40px; font-weight: 900; color: var(--accent); }
  .total-count { font-size: 13px; color: var(--text2); margin-top: 4px; }

  .cat-summary-item {
    margin: 6px 16px; background: var(--surface); border-radius: 14px; padding: 14px 16px;
  }
  .cat-sum-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .cat-sum-icon { font-size: 24px; }
  .cat-sum-name { flex: 1; font-size: 14px; font-weight: 600; }
  .cat-sum-amount { font-size: 16px; font-weight: 800; color: var(--accent); }
  .cat-sum-bar-bg { height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .cat-sum-bar { height: 100%; border-radius: 3px; background: var(--accent); transition: width 0.5s ease; }
  .cat-sum-meta { display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; color: var(--text2); }

  .csv-btn {
    margin: 16px; width: calc(100% - 32px); padding: 14px;
    border-radius: 14px; background: var(--surface2);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text); font-size: 14px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
  }

  /* MODAL */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.6); align-items: flex-end;
  }
  .modal-overlay.open { display: flex; }
  .modal-sheet {
    background: var(--surface); width: 100%; border-radius: 24px 24px 0 0;
    padding: 20px 16px; padding-bottom: calc(20px + var(--safe-bottom));
    animation: slideUp 0.25s ease;
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin: 0 auto 20px; }
  .modal-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
  .year-option {
    padding: 14px; border-radius: 12px; text-align: center;
    font-size: 16px; font-weight: 600; cursor: pointer;
    background: var(--surface2); margin-bottom: 8px; transition: all 0.15s;
  }
  .year-option.selected { background: rgba(245,200,66,0.15); color: var(--accent); }

  /* BOTTOM NAV padding */
  .bottom-nav-safe {
    background: var(--surface);
    padding-bottom: var(--safe-bottom);
    border-top: 1px solid rgba(255,255,255,0.07);
    flex-shrink: 0;
  }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="icon">ğŸ’¼</div>
  <div class="title">çµŒè²»ãƒ¡ãƒ¢</div>
  <div class="sub">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<!-- INSTALL BANNER -->
<div id="install-banner" style="position:relative;">
  <div>ğŸ“² ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ãˆã¾ã™ï¼</div>
  <div style="font-size:12px;font-weight:400;margin-top:2px;">Safari â†’ å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆâ–¡â†‘ï¼‰â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</div>
  <button class="banner-close" onclick="document.getElementById('install-banner').style.display='none'">Ã—</button>
</div>

<!-- HEADER -->
<header>
  <div class="header-title">ğŸ’¼ <span>çµŒè²»</span>ãƒ¡ãƒ¢</div>
  <button class="year-btn" id="year-btn" onclick="openYearModal()">2026å¹´</button>
</header>

<!-- TABS -->
<div class="tabs bottom-nav-safe" style="padding-bottom:0;">
  <div class="tab active" onclick="switchTab('scan')">
    <span class="tab-icon">ğŸ“·</span>ã‚¹ã‚­ãƒ£ãƒ³
  </div>
  <div class="tab" onclick="switchTab('list')">
    <span class="tab-icon">ğŸ“‹</span>ä¸€è¦§
  </div>
  <div class="tab" onclick="switchTab('summary')">
    <span class="tab-icon">ğŸ“Š</span>é›†è¨ˆ
  </div>
</div>

<!-- MAIN -->
<main>

  <!-- SCAN TAB -->
  <div class="page active" id="page-scan">
    <div class="scan-area" onclick="document.getElementById('file-input').click()">
      <div class="scan-icon">ğŸ“„</div>
      <p><strong>é ˜åæ›¸ã‚’ã‚¹ã‚­ãƒ£ãƒ³</strong><br>ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½± or ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</p>
    </div>
    <input type="file" id="file-input" accept="image/*" capture="environment" onchange="handleFile(event)">

    <div id="preview-section">
      <img id="preview-img" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
    </div>

    <div id="reading-status">
      <div class="spinner"></div>
      <div style="font-size:14px;color:var(--text2)">AIãŒèª­ã¿å–ã‚Šä¸­...</div>
    </div>

    <div id="result-card">
      <div class="result-row">
        <span class="result-label">é‡‘é¡</span>
        <span class="amount-big" id="result-amount">Â¥0</span>
      </div>
      <div class="result-row">
        <span class="result-label">åº—åãƒ»å†…å®¹</span>
        <span class="result-value" id="result-memo" style="font-size:13px;max-width:65%;text-align:right;"></span>
      </div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:8px;">ç§‘ç›®ã‚’é¸æŠ</div>
      <div class="cat-grid" id="cat-grid"></div>
      <div id="manual-note" style="display:none;background:rgba(255,107,107,0.1);border-radius:10px;padding:10px 12px;margin-bottom:12px;font-size:13px;color:#ff6b6b;">âš ï¸ ä¼šè­°è²» or ç¦åˆ©åšç”Ÿè²» ã‚’é¸ã‚“ã§ãã ã•ã„</div>
      <button class="save-btn" id="save-btn" onclick="saveExpense()" disabled>ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>

  <!-- LIST TAB -->
  <div class="page" id="page-list">
    <div class="list-filters" id="list-filters"></div>
    <div id="expense-list"></div>
  </div>

  <!-- SUMMARY TAB -->
  <div class="page" id="page-summary">
    <div class="summary-header">
      <div style="font-size:13px;color:var(--text2);" id="summary-year-label">2026å¹´ã®é›†è¨ˆ</div>
    </div>
    <div class="total-card">
      <div class="total-label">åˆè¨ˆçµŒè²»</div>
      <div class="total-amount" id="total-amount">Â¥0</div>
      <div class="total-count" id="total-count">0ä»¶</div>
    </div>
    <div id="cat-summaries"></div>
    <button class="csv-btn" onclick="exportCSV()">ğŸ“¥ CSVã§æ›¸ãå‡ºã™ï¼ˆExcelç”¨ï¼‰</button>
  </div>

</main>

<!-- Bottom safe area -->
<div class="bottom-nav-safe" style="display:none;" id="bottom-safe"></div>

<!-- YEAR MODAL -->
<div class="modal-overlay" id="year-modal" onclick="if(event.target===this)closeYearModal()">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">å¹´ã‚’é¸æŠ</div>
    <div id="year-options"></div>
  </div>
</div>

<script>
// ===== DATA =====
const CATEGORIES = [
  { id: 1, name: 'äº¤é€šè²»', icon: 'ğŸšƒ', color: '#60a5fa' },
  { id: 2, name: 'æ—…è²»äº¤é€šè²»', icon: 'âœˆï¸', color: '#a78bfa' },
  { id: 3, name: 'æ¥å¾…äº¤éš›è²»', icon: 'ğŸ½ï¸', color: '#f97316' },
  { id: 4, name: 'ä¼šè­°è²»', icon: 'ğŸ“', color: '#4ade80' },
  { id: 5, name: 'ç¦åˆ©åšç”Ÿè²»', icon: 'ğŸ', color: '#f472b6' },
];

const KEYWORDS = {
  äº¤é€šè²»: ['é›»è»Š','ãƒã‚¹','ã‚¿ã‚¯ã‚·ãƒ¼','åœ°ä¸‹é‰„','ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«','ä¹—è»Š','å®šæœŸ','suica','pasmo','icoca','è‡ªå‹•è»Š','ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°','é§è»Š','ã‚¬ã‚½ãƒªãƒ³','ã‚³ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°','é«˜é€Ÿ'],
  æ—…è²»äº¤é€šè²»: ['æ–°å¹¹ç·š','é£›è¡Œæ©Ÿ','èˆªç©º','ãƒ›ãƒ†ãƒ«','æ—…é¤¨','å®¿æ³Š','å‡ºå¼µ','ç©ºæ¸¯','jræ±æµ·','ana','jal'],
  æ¥å¾…äº¤éš›è²»: ['ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³','å±…é…’å±‹','ã‚«ãƒ•ã‚§','ã‚³ãƒ¼ãƒ’ãƒ¼','é£Ÿäº‹','é£²é£Ÿ','ãƒ©ãƒ³ãƒ','ãƒ‡ã‚£ãƒŠãƒ¼','æ‡‡è¦ª','æ¥å¾…','bar','ãƒãƒ¼'],
};

let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
let selectedYear = new Date().getFullYear();
let currentResult = null;
let selectedCatId = null;
let currentFilter = 'all';

function saveData() { localStorage.setItem('expenses', JSON.stringify(expenses)); }

// ===== SPLASH =====
window.addEventListener('load', () => {
  setTimeout(() => {
    const splash = document.getElementById('splash');
    splash.style.opacity = '0';
    setTimeout(() => { splash.style.display = 'none'; }, 500);
  }, 1200);

  // Show install banner if not in standalone mode
  if (!window.navigator.standalone && /iphone|ipad|ipod/i.test(navigator.userAgent)) {
    document.getElementById('install-banner').style.display = 'flex';
  }

  renderAll();
});

// ===== TABS =====
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
  event.currentTarget.classList.add('active');
  if (tab === 'summary') renderSummary();
  if (tab === 'list') renderList();
}

// ===== FILE HANDLING =====
function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    document.getElementById('preview-section').style.display = 'block';
    document.getElementById('preview-img').src = ev.target.result;
    document.getElementById('result-card').style.display = 'none';
    analyzeImage(ev.target.result, file);
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

async function analyzeImage(dataUrl, file) {
  document.getElementById('reading-status').style.display = 'block';

  const base64 = dataUrl.split(',')[1];
  const mediaType = file.type || 'image/jpeg';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
            { type: 'text', text: `ã“ã®é ˜åæ›¸ãƒ»ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‹ã‚‰ä»¥ä¸‹ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚å¿…ãšJSONå½¢å¼ã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆä»–ã®ãƒ†ã‚­ã‚¹ãƒˆä¸è¦ï¼‰:
{"amount": æ•°å€¤ï¼ˆå††ã€ç¨è¾¼åˆè¨ˆï¼‰, "memo": "åº—åã‚„å†…å®¹ï¼ˆ30æ–‡å­—ä»¥å†…ï¼‰", "keywords": "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§ï¼ˆäº¤é€šæ‰‹æ®µãƒ»é£Ÿäº‹ãƒ»å®¿æ³Šãªã©ï¼‰"}` }
          ]
        }]
      })
    });

    const data = await response.json();
    const text = data.content?.[0]?.text || '{}';
    const clean = text.replace(/```json?|```/g, '').trim();
    const result = JSON.parse(clean);
    showResult(result);
  } catch (err) {
    // Fallback: manual entry
    showResult({ amount: 0, memo: 'æ‰‹å‹•å…¥åŠ›', keywords: '' });
  }
}

function showResult(result) {
  document.getElementById('reading-status').style.display = 'none';
  document.getElementById('result-card').style.display = 'block';

  currentResult = result;
  selectedCatId = null;

  document.getElementById('result-amount').textContent = result.amount ? 'Â¥' + result.amount.toLocaleString() : 'é‡‘é¡ä¸æ˜';
  document.getElementById('result-memo').textContent = result.memo || '';

  // Auto-detect category
  const kw = (result.keywords || '').toLowerCase() + ' ' + (result.memo || '').toLowerCase();
  let autoCat = null;

  // Check æ—…è²»äº¤é€šè²» first (10ä¸‡ä»¥ä¸Š or å®¿æ³Š or é£›è¡Œæ©Ÿ)
  if (result.amount >= 100000 || KEYWORDS.æ—…è²»äº¤é€šè²».some(k => kw.includes(k))) {
    autoCat = 2;
  } else if (KEYWORDS.äº¤é€šè²».some(k => kw.includes(k.toLowerCase()))) {
    autoCat = 1;
  } else if (KEYWORDS.æ¥å¾…äº¤éš›è²».some(k => kw.includes(k.toLowerCase()))) {
    autoCat = 3;
  }

  // Render category grid
  const grid = document.getElementById('cat-grid');
  grid.innerHTML = '';
  CATEGORIES.forEach(cat => {
    const btn = document.createElement('div');
    btn.className = 'cat-btn' + (cat.id === autoCat ? ' auto-detected' : '');
    btn.innerHTML = `<span class="cat-icon">${cat.icon}</span>${cat.name}${cat.id === autoCat ? '<br><small style="font-size:10px">è‡ªå‹•æ¤œå‡º</small>' : ''}`;
    btn.onclick = () => selectCat(cat.id);
    grid.appendChild(btn);
  });

  if (autoCat) {
    selectCat(autoCat);
  } else if (!autoCat) {
    document.getElementById('manual-note').style.display = 'block';
  }
}

function selectCat(id) {
  selectedCatId = id;
  document.querySelectorAll('.cat-btn').forEach((btn, i) => {
    btn.classList.remove('selected', 'auto-detected');
    if (CATEGORIES[i].id === id) btn.classList.add('selected');
  });
  document.getElementById('manual-note').style.display = 'none';
  document.getElementById('save-btn').disabled = false;
}

function saveExpense() {
  if (!currentResult || !selectedCatId) return;
  const cat = CATEGORIES.find(c => c.id === selectedCatId);
  const expense = {
    id: Date.now(),
    catId: selectedCatId,
    catName: cat.name,
    catIcon: cat.icon,
    amount: currentResult.amount || 0,
    memo: currentResult.memo || '',
    date: new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }),
    year: new Date().getFullYear(),
  };
  expenses.unshift(expense);
  saveData();

  // Reset
  document.getElementById('result-card').style.display = 'none';
  document.getElementById('preview-section').style.display = 'none';
  currentResult = null;
  selectedCatId = null;

  // Feedback
  showToast('ä¿å­˜ã—ã¾ã—ãŸï¼');
}

// ===== LIST =====
function renderList() {
  // Filters
  const filterDiv = document.getElementById('list-filters');
  filterDiv.innerHTML = '';
  const filters = [{ id: 'all', name: 'ã™ã¹ã¦' }, ...CATEGORIES];
  filters.forEach(f => {
    const chip = document.createElement('div');
    chip.className = 'filter-chip' + (currentFilter === f.id ? ' active' : '');
    chip.textContent = (f.icon || '') + ' ' + f.name;
    chip.onclick = () => { currentFilter = f.id; renderList(); };
    filterDiv.appendChild(chip);
  });

  // Expenses
  const listDiv = document.getElementById('expense-list');
  const yearExpenses = expenses.filter(e => e.year === selectedYear);
  const filtered = currentFilter === 'all' ? yearExpenses : yearExpenses.filter(e => e.catId === currentFilter);

  if (filtered.length === 0) {
    listDiv.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
    return;
  }

  listDiv.innerHTML = '';
  filtered.forEach(exp => {
    const item = document.createElement('div');
    item.className = 'expense-item';
    item.innerHTML = `
      <div class="expense-cat-icon">${exp.catIcon}</div>
      <div class="expense-info">
        <div class="expense-cat-name">${exp.catName}</div>
        <div class="expense-date">${exp.date}</div>
        <div class="expense-memo">${exp.memo || ''}</div>
      </div>
      <div class="expense-amount">Â¥${exp.amount.toLocaleString()}</div>
      <button class="delete-btn" onclick="deleteExpense(${exp.id})">ğŸ—‘</button>
    `;
    listDiv.appendChild(item);
  });
}

function deleteExpense(id) {
  if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  expenses = expenses.filter(e => e.id !== id);
  saveData();
  renderList();
}

// ===== SUMMARY =====
function renderSummary() {
  document.getElementById('summary-year-label').textContent = selectedYear + 'å¹´ã®é›†è¨ˆ';
  const yearExpenses = expenses.filter(e => e.year === selectedYear);
  const total = yearExpenses.reduce((sum, e) => sum + e.amount, 0);
  document.getElementById('total-amount').textContent = 'Â¥' + total.toLocaleString();
  document.getElementById('total-count').textContent = yearExpenses.length + 'ä»¶';

  const summariesDiv = document.getElementById('cat-summaries');
  summariesDiv.innerHTML = '';
  CATEGORIES.forEach(cat => {
    const catExp = yearExpenses.filter(e => e.catId === cat.id);
    const catTotal = catExp.reduce((sum, e) => sum + e.amount, 0);
    if (catTotal === 0) return;
    const pct = total > 0 ? Math.round(catTotal / total * 100) : 0;
    const item = document.createElement('div');
    item.className = 'cat-summary-item';
    item.innerHTML = `
      <div class="cat-sum-header">
        <span class="cat-sum-icon">${cat.icon}</span>
        <span class="cat-sum-name">${cat.name}</span>
        <span class="cat-sum-amount">Â¥${catTotal.toLocaleString()}</span>
      </div>
      <div class="cat-sum-bar-bg"><div class="cat-sum-bar" style="width:${pct}%"></div></div>
      <div class="cat-sum-meta"><span>${catExp.length}ä»¶</span><span>${pct}%</span></div>
    `;
    summariesDiv.appendChild(item);
  });
}

// ===== YEAR MODAL =====
function openYearModal() {
  const container = document.getElementById('year-options');
  container.innerHTML = '';
  const currentYear = new Date().getFullYear();
  [currentYear, currentYear - 1, currentYear - 2].forEach(y => {
    const opt = document.createElement('div');
    opt.className = 'year-option' + (y === selectedYear ? ' selected' : '');
    opt.textContent = y + 'å¹´';
    opt.onclick = () => { selectedYear = y; document.getElementById('year-btn').textContent = y + 'å¹´'; closeYearModal(); renderList(); renderSummary(); };
    container.appendChild(opt);
  });
  document.getElementById('year-modal').classList.add('open');
}
function closeYearModal() { document.getElementById('year-modal').classList.remove('open'); }

// ===== CSV =====
function exportCSV() {
  const yearExpenses = expenses.filter(e => e.year === selectedYear);
  if (yearExpenses.length === 0) { showToast('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  let csv = '\uFEFFæ—¥ä»˜,ç§‘ç›®,é‡‘é¡,å†…å®¹\n';
  yearExpenses.forEach(e => {
    csv += `${e.date},${e.catName},${e.amount},"${e.memo}"\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `keiri_${selectedYear}.csv`; a.click();
  URL.revokeObjectURL(url);
}

// ===== TOAST =====
function showToast(msg) {
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;bottom:calc(80px + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%);background:#4ade80;color:#000;padding:10px 20px;border-radius:20px;font-size:14px;font-weight:700;z-index:500;animation:slideIn 0.2s ease';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}

function renderAll() { renderList(); renderSummary(); }
</script>
</body>
</html>
